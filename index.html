<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‰å­æ£‹å¤§å¯¹å†³</title>
    <!-- å¼•å…¥ Inter å­—ä½“ï¼Œç¡®ä¿æ˜¾ç¤ºæ•ˆæœä¸€è‡´ -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap" rel="stylesheet">
    <!-- å¼•å…¥ Tone.js åº“ç”¨äºéŸ³é¢‘å¤„ç† -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        /* å…¨å±€æ ·å¼ */
        body {
            font-family: 'Inter', sans-serif; /* ä½¿ç”¨ Inter å­—ä½“ */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            /* æ›´åŠ ç”ŸåŠ¨æ´»æ³¼çš„å¾„å‘æ¸å˜èƒŒæ™¯ */
            background: radial-gradient(circle at top left, #84fab0 0%, #8fd3f4 100%);
            margin: 0;
            padding: 20px;
            box-sizing: border-box; /* ç¡®ä¿ padding ä¸ä¼šå¢åŠ æ€»å®½åº¦ */
            overflow: auto; /* é˜²æ­¢å†…å®¹æº¢å‡ºæ—¶å‡ºç°æ»šåŠ¨æ¡ */
        }

        /* æ¸¸æˆå®¹å™¨ */
        .game-container {
            background-color: #ffffff; /* çº¯ç™½è‰²èƒŒæ™¯ */
            border-radius: 20px; /* æ›´åœ†æ¶¦çš„è¾¹æ¡† */
            /* æ›´å…·æ´»åŠ›çš„é˜´å½±æ•ˆæœ */
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.25), 0 0 0 8px rgba(255, 255, 255, 0.6);
            padding: 45px;
            text-align: center;
            max-width: 90%; /* æœ€å¤§å®½åº¦é€‚åº”ç§»åŠ¨è®¾å¤‡ */
            width: 480px; /* é€‚å½“å¢åŠ å®½åº¦ */
            position: relative; /* ç”¨äºéŸ³ä¹æ§åˆ¶æŒ‰é’®å®šä½ */
            border: 2px solid rgba(0, 0, 0, 0.08); /* é¢å¤– subtle è¾¹æ¡† */
            animation: fadeIn 0.8s ease-out; /* å®¹å™¨æ·¡å…¥åŠ¨ç”» */
        }

        /* æ ‡é¢˜ */
        h1 {
            color: #34495e; /* æ·±è“è‰²æ–‡å­— */
            margin-bottom: 35px;
            font-size: 3.5em; /* æ›´å¤§çš„æ ‡é¢˜å­—å· */
            font-weight: 800; /* æ›´ç²—çš„å­—ä½“ */
            letter-spacing: 2px;
            position: relative;
            /* å¤šå±‚æ–‡å­—é˜´å½±ï¼Œè¥é€ ç«‹ä½“æ„Ÿ */
            text-shadow: 3px 3px 0px rgba(0,0,0,0.1), 5px 5px 0px rgba(0,0,0,0.05);
        }
        h1::after {
            content: '';
            position: absolute;
            bottom: -18px;
            left: 50%;
            transform: translateX(-50%);
            width: 90px;
            height: 5px;
            background-color: #457b9d; /* æ ‡é¢˜ä¸‹åˆ’çº¿é¢œè‰² */
            border-radius: 4px;
            animation: slideIn 1s ease-out; /* ä¸‹åˆ’çº¿æ»‘åŠ¨åŠ¨ç”» */
        }

        /* æ¸¸æˆæ¿ */
        .board {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* ä¸‰åˆ—ç­‰å®½ */
            grid-template-rows: repeat(3, 1fr); /* ä¸‰è¡Œç­‰é«˜ */
            gap: 12px; /* å•å…ƒæ ¼ä¹‹é—´çš„é—´è· */
            margin: 35px auto;
            border: 6px solid #2980b9; /* æ›´ç²—ã€æ›´æ·±çš„æ£‹ç›˜è¾¹æ¡† */
            border-radius: 18px; /* æ›´åœ†æ¶¦çš„æ£‹ç›˜åœ†è§’ */
            overflow: hidden; /* é˜²æ­¢å†…éƒ¨å…ƒç´ è¶…å‡ºè¾¹æ¡† */
            width: 100%; /* æ£‹ç›˜å®½åº¦è‡ªé€‚åº”å®¹å™¨ */
            max-width: 380px; /* é™åˆ¶æœ€å¤§å®½åº¦ */
            aspect-ratio: 1 / 1; /* ä¿æŒæ­£æ–¹å½¢æ¯”ä¾‹ */
            background-color: #ecf0f1; /* æ£‹ç›˜èƒŒæ™¯è‰² */
            box-shadow: inset 0 0 15px rgba(0,0,0,0.1); /* æ£‹ç›˜å†…é˜´å½± */
        }

        /* æ£‹ç›˜å•å…ƒæ ¼ */
        .cell {
            background-color: #a8dadc; /* å•å…ƒæ ¼èƒŒæ™¯è‰²ï¼Œæ›´é²œäº® */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 4.8em; /* æ›´å¤§çš„æ ‡è®°å­—å· */
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.3s ease; /* æ›´å¤šè¿‡æ¸¡æ•ˆæœ */
            user-select: none; /* é˜²æ­¢æ–‡æœ¬è¢«é€‰ä¸­ */
            border-radius: 10px; /* å•å…ƒæ ¼åœ†è§’ */
            color: #1d3557; /* é»˜è®¤æ–‡æœ¬é¢œè‰²ï¼Œä»¥é˜²ä¸‡ä¸€ */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* å•å…ƒæ ¼æ·±åº¦é˜´å½± */
        }

        .cell:hover {
            background-color: #7abcc2; /* é¼ æ ‡æ‚¬åœæ—¶çš„èƒŒæ™¯è‰² */
            transform: scale(1.06); /* è½»å¾®æ”¾å¤§æ•ˆæœ */
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2); /* æ‚¬åœæ—¶é˜´å½±åŠ æ·± */
            filter: brightness(1.1); /* æ‚¬åœæ—¶äº®åº¦å¢åŠ  */
        }

        .cell.x {
            color: #ff6b6b; /* X çš„é²œè‰³çº¢è‰² */
            text-shadow: 4px 4px 8px rgba(0, 0, 0, 0.25);
        }

        .cell.o {
            color: #1abc9c; /* O çš„é²œè‰³é’è‰² */
            text-shadow: 4px 4px 8px rgba(0, 0, 0, 0.25);
        }

        /* æ”¾ç½®æ ‡è®°æ—¶çš„åŠ¨ç”» */
        .cell.pop {
            animation: cell-pop 0.2s ease-out;
        }
        @keyframes cell-pop {
            0% { transform: scale(0.8); opacity: 0.5; }
            80% { transform: scale(1.15); opacity: 1; }
            100% { transform: scale(1); }
        }

        /* èƒœåˆ©æ—¶çš„å•å…ƒæ ¼åŠ¨ç”» */
        .winning-cell {
            animation: pulse-glow 1s infinite alternate; /* è„‰å†²å‘å…‰åŠ¨ç”» */
        }

        @keyframes pulse-glow {
            0% {
                transform: scale(1);
                box-shadow: 0 0 10px rgba(255, 255, 255, 0.5), 0 0 0px var(--winning-color);
            }
            50% {
                transform: scale(1.1); /* ç¨å¾®æ”¾å¤§ */
                box-shadow: 0 0 25px rgba(255, 255, 255, 0.8), 0 0 35px var(--winning-color); /* æ›´å¼ºçš„å‘å…‰ */
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 10px rgba(255, 255, 255, 0.5), 0 0 0px var(--winning-color);
            }
        }
        /* æ ¹æ®ç©å®¶è®¾ç½®èƒœåˆ©é¢œè‰²å˜é‡ */
        .cell.x.winning-cell {
            --winning-color: #ff6b6b; /* X çš„èƒœåˆ©é¢œè‰² */
        }
        .cell.o.winning-cell {
            --winning-color: #1abc9c; /* O çš„èƒœåˆ©é¢œè‰² */
        }


        /* æ¶ˆæ¯æ˜¾ç¤º */
        #message {
            margin-top: 35px;
            font-size: 1.8em; /* æ›´å¤§çš„å­—å· */
            color: #2c3e50;
            font-weight: bold;
            min-height: 2em; /* ç¡®ä¿æ¶ˆæ¯åŒºåŸŸé«˜åº¦ç¨³å®š */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.08);
            animation: bounceIn 0.5s ease-out; /* æ¶ˆæ¯å¼¹è·³åŠ¨ç”» */
        }

        /* æŒ‰é’®æ ·å¼ */
        button {
            margin-top: 40px;
            padding: 18px 40px;
            font-size: 1.3em;
            cursor: pointer;
            /* æ›´æœ‰æ´»åŠ›çš„æ©™è‰²æ¸å˜æŒ‰é’® */
            background: linear-gradient(135deg, #ff8c00, #ff6347);
            color: white;
            border: none;
            border-radius: 12px; /* æ›´åœ†æ¶¦çš„æŒ‰é’® */
            box-shadow: 0 8px 20px rgba(255, 140, 0, 0.4), 0 3px 0 rgba(190, 80, 20, 0.6); /* æŒ‰é’®é˜´å½±å’Œåº•éƒ¨è¾¹æ¡†é˜´å½± */
            transition: all 0.3s ease; /* å¹³æ»‘è¿‡æ¸¡æ•ˆæœ */
            font-weight: bold;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.15);
        }

        button:hover {
            background: linear-gradient(135deg, #ff6347, #ff8c00); /* æ‚¬åœæ—¶æ¸å˜åè½¬ */
            box-shadow: 0 10px 25px rgba(255, 140, 0, 0.5), 0 3px 0 rgba(190, 80, 20, 0.8);
            transform: translateY(-4px); /* æ›´æ˜æ˜¾ä¸Šæµ®æ•ˆæœ */
        }

        button:active {
            transform: translateY(0); /* ç‚¹å‡»æ—¶æ¢å¤ */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3), inset 0 3px 5px rgba(0,0,0,0.2); /* ç‚¹å‡»æ—¶å†…å‡¹æ•ˆæœ */
        }

        /* éŸ³ä¹æ§åˆ¶æŒ‰é’® */
        #musicToggle {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 45px;
            height: 45px;
            background-color: rgba(255, 255, 255, 0.4); /* æ›´é€æ˜çš„èƒŒæ™¯ */
            border: none;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.8em; /* æ›´å¤§çš„å›¾æ ‡ */
            cursor: pointer;
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        #musicToggle:hover {
            background-color: rgba(255, 255, 255, 0.6);
            transform: scale(1.1); /* æ‚¬åœæ”¾å¤§ */
        }

        #musicToggle:active {
            transform: scale(0.95); /* ç‚¹å‡»ç¼©å° */
        }

        /* åŠ¨ç”»å…³é”®å¸§ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { width: 0; }
            to { width: 90px; }
        }

        @keyframes bounceIn {
            0%, 20%, 40%, 60%, 80%, 100% {
                transition-timing-function: cubic-bezier(0.215, 0.610, 0.355, 1.000);
            }
            0% { opacity: 0; transform: scale3d(0.3, 0.3, 0.3); }
            20% { transform: scale3d(1.1, 1.1, 1.1); }
            40% { transform: scale3d(0.9, 0.9, 0.9); }
            60% { opacity: 1; transform: scale3d(1.03, 1.03, 1.03); }
            80% { transform: scale3d(0.97, 0.97, 0.97); }
            100% { opacity: 1; transform: scale3d(1, 1, 1); }
        }


        /* å“åº”å¼è®¾è®¡ï¼šå°å±å¹•é€‚é… */
        @media (max-width: 600px) {
            .game-container {
                padding: 25px;
                max-width: 95%;
                width: 100%; /* å°å±å¹•ä¸‹å®½åº¦å¡«æ»¡ */
            }
            h1 {
                font-size: 2.5em;
                margin-bottom: 25px;
            }
            h1::after {
                width: 60px;
                bottom: -10px;
            }
            .board {
                max-width: 290px; /* æ›´å°çš„æ£‹ç›˜ */
                margin: 25px auto;
                gap: 8px;
                border-width: 4px;
            }
            .cell {
                font-size: 3.5em; /* æ›´å°çš„æ ‡è®°å­—å· */
                border-radius: 8px;
            }
            #message {
                font-size: 1.4em;
                margin-top: 25px;
            }
            button {
                padding: 14px 30px;
                font-size: 1.15em;
                margin-top: 30px;
            }
            #musicToggle {
                width: 40px;
                height: 40px;
                font-size: 1.6em;
                top: 15px;
                right: 15px;
            }
        }

        /* é’ˆå¯¹å®½å±çš„é¢å¤–è°ƒæ•´ */
        @media (min-width: 1024px) {
            .game-container {
                padding: 60px; /* å®½å±ä¸‹æ›´å¤§å†…è¾¹è· */
                width: 550px; /* å®½å±ä¸‹ç•¥å¤§å®½åº¦ */
            }
            h1 {
                font-size: 4em;
            }
            h1::after {
                width: 100px;
            }
            .board {
                max-width: 450px; /* å®½å±ä¸‹æ›´å¤§æ£‹ç›˜ */
                gap: 15px;
                border-width: 7px;
            }
            .cell {
                font-size: 5.5em;
            }
            button {
                padding: 20px 45px;
                font-size: 1.4em;
            }
            #musicToggle {
                width: 50px;
                height: 50px;
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>ä¸‰å­æ£‹å¤§å¯¹å†³</h1>
        <div class="board" id="gameBoard">
            <!-- 9ä¸ªå•å…ƒæ ¼ä»£è¡¨æ£‹ç›˜ -->
            <div class="cell" data-cell-index="0"></div>
            <div class="cell" data-cell-index="1"></div>
            <div class="cell" data-cell-index="2"></div>
            <div class="cell" data-cell-index="3"></div>
            <div class="cell" data-cell-index="4"></div>
            <div class="cell" data-cell-index="5"></div>
            <div class="cell" data-cell-index="6"></div>
            <div class="cell" data-cell-index="7"></div>
            <div class="cell" data-cell-index="8"></div>
        </div>
        <p id="message">ç‚¹å‡»ä»»æ„æ ¼å­å¼€å§‹æ¸¸æˆå¹¶æ’­æ”¾éŸ³ä¹</p>
        <button id="restartButton">é‡æ–°å¼€å§‹</button>
        <button id="musicToggle">ğŸµ</button> <!-- éŸ³ä¹å¼€å…³æŒ‰é’® -->
    </div>

    <script>
        // è·å–æ‰€æœ‰æ£‹ç›˜å•å…ƒæ ¼ã€æ¶ˆæ¯æ˜¾ç¤ºåŒºåŸŸå’Œé‡æ–°å¼€å§‹æŒ‰é’®
        const cells = document.querySelectorAll('.cell');
        const messageDisplay = document.getElementById('message');
        const restartButton = document.getElementById('restartButton');
        const musicToggleButton = document.getElementById('musicToggle');

        // æ¸¸æˆçŠ¶æ€æ•°ç»„ï¼Œåˆå§‹ä¸ºç©º
        let board = ['', '', '', '', '', '', '', '', ''];
        // å½“å‰ç©å®¶ï¼Œé»˜è®¤ä¸º 'X'
        let currentPlayer = 'X';
        // æ¸¸æˆæ˜¯å¦æ´»è·ƒï¼Œå³æ˜¯å¦å¯ä»¥ç»§ç»­ç©
        let gameActive = true;
        // éŸ³ä¹æ˜¯å¦æ’­æ”¾
        let musicPlaying = false;
        // Tone.js ä¸Šä¸‹æ–‡æ˜¯å¦å·²åˆå§‹åŒ–
        let audioContextReady = false;

        // è·èƒœæ¡ä»¶ï¼Œå®šä¹‰äº†æ‰€æœ‰å¯èƒ½çš„è¿çº¿ç»„åˆ
        const winningConditions = [
            [0, 1, 2], // é¡¶è¡Œ
            [3, 4, 5], // ä¸­è¡Œ
            [6, 7, 8], // åº•è¡Œ
            [0, 3, 6], // å·¦åˆ—
            [1, 4, 7], // ä¸­åˆ—
            [2, 5, 8], // å³åˆ—
            [0, 4, 8], // ä¸»å¯¹è§’çº¿
            [2, 4, 6]  // åå¯¹è§’çº¿
        ];

        // --- Tone.js éŸ³é¢‘è®¾ç½® ---

        // å…¨å±€æ··å“æ•ˆæœï¼Œå¢åŠ ç©ºé—´æ„Ÿ
        const reverb = new Tone.Reverb({
            decay: 1.5,      // æ··å“è¡°å‡æ—¶é—´
            preDelay: 0.01,  // é¢„å»¶è¿Ÿ
            wet: 0.2         // æ¹¿ä¿¡å·ï¼ˆæ··å“ï¼‰æ··åˆæ¯”ä¾‹
        }).toDestination(); // æ··å“æ•ˆæœå™¨è¾“å‡ºåˆ°æœ€ç»ˆç›®çš„åœ°ï¼ˆæ‰¬å£°å™¨ï¼‰

        // æ”¾ç½®æ ‡è®°éŸ³æ•ˆåˆæˆå™¨
        const placeMarkSynth = new Tone.MembraneSynth().connect(reverb); // è¿æ¥åˆ°æ··å“
        // èƒœåˆ©éŸ³æ•ˆåˆæˆå™¨
        const winSynth = new Tone.PolySynth(Tone.Synth, {
            oscillator: { type: "sawtooth" },
            envelope: {
                attack: 0.05,
                decay: 0.3,
                sustain: 0.4,
                release: 0.8,
            },
        }).connect(reverb); // è¿æ¥åˆ°æ··å“
        // å¹³å±€éŸ³æ•ˆåˆæˆå™¨
        const drawSynth = new Tone.PolySynth(Tone.Synth, {
            oscillator: { type: "triangle" },
            envelope: {
                attack: 0.02,
                decay: 0.2,
                sustain: 0.3,
                release: 0.5,
            },
        }).connect(reverb); // è¿æ¥åˆ°æ··å“
        // é‡æ–°å¼€å§‹éŸ³æ•ˆåˆæˆå™¨
        const restartSynth = new Tone.Synth().connect(reverb); // è¿æ¥åˆ°æ··å“

        // èƒŒæ™¯éŸ³ä¹éƒ¨åˆ†
        let musicLoop;
        let bgMusicVolume = new Tone.Volume(-15); // åˆå§‹éŸ³é‡ä¸º -15dB
        // ä½¿ç”¨ DuoSynth åˆ¶ä½œæ›´ä¸°å¯Œçš„èƒŒæ™¯éŸ³ä¹å£°éŸ³
        const bgMusicSynth = new Tone.DuoSynth({
            vibratoAmount: 0.5,
            vibratoRate: 5,
            harmonicity: 1.5,
            voice0: {
                volume: -10,
                portamento: 0,
                oscillator: { type: "sine" },
                envelope: {
                    attack: 0.01,
                    decay: 0.3,
                    sustain: 0.2,
                    release: 1
                },
                filterEnvelope: {
                    baseFrequency: 200,
                    octaves: 2,
                    attack: 0.01,
                    decay: 0.1,
                    sustain: 0.5,
                    release: 0.8
                }
            },
            voice1: {
                volume: -10,
                portamento: 0,
                oscillator: { type: "sine" },
                envelope: {
                    attack: 0.01,
                    decay: 0.3,
                    sustain: 0.2,
                    release: 1
                },
                filterEnvelope: {
                    baseFrequency: 200,
                    octaves: 2,
                    attack: 0.01,
                    decay: 0.1,
                    sustain: 0.5,
                    release: 0.8
                }
            }
        }).connect(bgMusicVolume); // èƒŒæ™¯éŸ³ä¹è¿æ¥åˆ°å…¶éŸ³é‡æ§åˆ¶
        bgMusicVolume.connect(reverb); // éŸ³é‡æ§åˆ¶å†è¿æ¥åˆ°æ··å“

        // åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡çš„å‡½æ•°
        async function initializeAudioContext() {
            if (!audioContextReady) {
                try {
                    await Tone.start();
                    console.log("éŸ³é¢‘ä¸Šä¸‹æ–‡å·²åˆå§‹åŒ–");
                    audioContextReady = true;
                    // ä¸€æ—¦éŸ³é¢‘ä¸Šä¸‹æ–‡å‡†å¤‡å¥½ï¼Œå°±å°è¯•å¼€å§‹æ’­æ”¾éŸ³ä¹
                    toggleMusic();
                    messageDisplay.innerHTML = `ç©å®¶ X çš„å›åˆ`;
                } catch (e) {
                    console.error("éŸ³é¢‘ä¸Šä¸‹æ–‡åˆå§‹åŒ–å¤±è´¥:", e);
                    messageDisplay.innerHTML = `éŸ³é¢‘å¯åŠ¨å¤±è´¥ï¼Œè¯·ç‚¹å‡»ä»¥ç»§ç»­ã€‚`;
                }
            }
        }

        // éŸ³ä¹æ’­æ”¾å™¨ï¼Œåªåœ¨éŸ³é¢‘ä¸Šä¸‹æ–‡åˆå§‹åŒ–ååˆ›å»º
        function setupMusic() {
            if (musicLoop) return; // é˜²æ­¢é‡å¤åˆ›å»º

            // åˆ›å»ºä¸€ä¸ªæ›´æœ‰è¶£çš„éŸ³ä¹åºåˆ—
            const melody = [
                { time: '0:0', note: 'C4', duration: '4n' },
                { time: '0:1', note: 'E4', duration: '4n' },
                { time: '0:2', note: 'G4', duration: '4n' },
                { time: '0:3', note: 'C5', duration: '4n' }, // æ›´é«˜éŸ³
                { time: '1:0', note: 'A4', duration: '4n' }, // ä¸åŒçš„éŸ³ç¬¦åºåˆ—
                { time: '1:1', note: 'F4', duration: '4n' },
                { time: '1:2', note: 'D4', duration: '4n' },
                { time: '1:3', note: 'G4', duration: '4n' },
            ];

            musicLoop = new Tone.Part((time, value) => {
                bgMusicSynth.triggerAttackRelease(value.note, value.duration, time);
            }, melody);

            musicLoop.loop = true; // å¾ªç¯æ’­æ”¾
            musicLoop.loopEnd = '2m'; // å¾ªç¯é•¿åº¦2å°èŠ‚
            Tone.Transport.bpm.value = 100; // è®¾ç½®BPM
            Tone.Transport.start(); // å¯åŠ¨ä¼ è¾“ï¼Œä½†éŸ³ä¹æš‚åœ
        }

        // éŸ³ä¹å¼€å…³å‡½æ•°
        function toggleMusic() {
            if (!audioContextReady) {
                // å¦‚æœéŸ³é¢‘ä¸Šä¸‹æ–‡æœªå‡†å¤‡å¥½ï¼Œå…ˆåˆå§‹åŒ–
                initializeAudioContext();
                return;
            }

            if (!musicPlaying) {
                setupMusic(); // ç¡®ä¿éŸ³ä¹å·²è®¾ç½®
                musicLoop.start(0); // ä»å¤´å¼€å§‹æ’­æ”¾
                musicPlaying = true;
                musicToggleButton.textContent = 'ğŸ”‡'; // æ˜¾ç¤ºé™éŸ³å›¾æ ‡
                console.log("èƒŒæ™¯éŸ³ä¹å·²æ’­æ”¾");
            } else {
                musicLoop.stop(); // åœæ­¢æ’­æ”¾
                musicPlaying = false;
                musicToggleButton.textContent = 'ğŸµ'; // æ˜¾ç¤ºæ’­æ”¾å›¾æ ‡
                console.log("èƒŒæ™¯éŸ³ä¹å·²æš‚åœ");
            }
        }

        // --- æ¸¸æˆé€»è¾‘ ---

        /**
         * å¤„ç†å•å…ƒæ ¼ç‚¹å‡»äº‹ä»¶
         * @param {Event} event - ç‚¹å‡»äº‹ä»¶å¯¹è±¡
         */
        function handleCellClick(event) {
            // åœ¨ç¬¬ä¸€æ¬¡ç‚¹å‡»æ—¶åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡å’Œå¼€å§‹æ’­æ”¾éŸ³ä¹
            initializeAudioContext();

            const clickedCell = event.target;
            // è·å–ç‚¹å‡»å•å…ƒæ ¼çš„ç´¢å¼•
            const clickedCellIndex = parseInt(clickedCell.getAttribute('data-cell-index'));

            // å¦‚æœå•å…ƒæ ¼å·²è¢«å ç”¨æˆ–æ¸¸æˆä¸æ´»è·ƒï¼Œåˆ™ä¸æ‰§è¡Œä»»ä½•æ“ä½œ
            if (board[clickedCellIndex] !== '' || !gameActive) {
                return;
            }

            // æ’­æ”¾æ”¾ç½®æ ‡è®°éŸ³æ•ˆ
            placeMarkSynth.triggerAttackRelease('C4', '8n');

            // æ›´æ–°æ¸¸æˆæ¿çŠ¶æ€å’Œå•å…ƒæ ¼å†…å®¹
            board[clickedCellIndex] = currentPlayer;
            clickedCell.innerHTML = currentPlayer;
            // ä¸ºå•å…ƒæ ¼æ·»åŠ å¯¹åº”çš„ç©å®¶ç±»å (x æˆ– o) ç”¨äºæ ·å¼
            clickedCell.classList.add(currentPlayer.toLowerCase());
            // æ·»åŠ  pop ç±»è§¦å‘æ”¾ç½®åŠ¨ç”»
            clickedCell.classList.add('pop');

            // åŠ¨ç”»ç»“æŸåç§»é™¤ pop ç±»ï¼Œä»¥ä¾¿ä¸‹æ¬¡å†æ¬¡è§¦å‘
            clickedCell.addEventListener('animationend', () => {
                clickedCell.classList.remove('pop');
            }, { once: true });

            // æ£€æŸ¥æ¸¸æˆç»“æœï¼ˆèƒœåˆ©æˆ–å¹³å±€ï¼‰
            checkResult();
        }

        /**
         * æ£€æŸ¥æ¸¸æˆç»“æœï¼ˆèƒœåˆ©æˆ–å¹³å±€ï¼‰
         */
        function checkResult() {
            let roundWon = false; // æ ‡è®°æœ¬å›åˆæ˜¯å¦æœ‰äººè·èƒœ
            let winningLine = []; // å­˜å‚¨è·èƒœçš„å•å…ƒæ ¼ç´¢å¼•

            // éå†æ‰€æœ‰è·èƒœæ¡ä»¶
            for (let i = 0; i < winningConditions.length; i++) {
                const winCondition = winningConditions[i];
                // è·å–å½“å‰è·èƒœæ¡ä»¶å¯¹åº”çš„ä¸‰ä¸ªå•å…ƒæ ¼çš„å€¼
                let a = board[winCondition[0]];
                let b = board[winCondition[1]];
                let c = board[winCondition[2]];

                // å¦‚æœä»»ä½•ä¸€ä¸ªå•å…ƒæ ¼ä¸ºç©ºï¼Œåˆ™æ­¤æ¡ä»¶ä¸æˆç«‹ï¼Œç»§ç»­ä¸‹ä¸€ä¸ªæ¡ä»¶
                if (a === '' || b === '' || c === '') {
                    continue;
                }
                // å¦‚æœä¸‰ä¸ªå•å…ƒæ ¼çš„å€¼ç›¸åŒï¼Œåˆ™è¡¨ç¤ºæœ‰ç©å®¶è·èƒœ
                if (a === b && b === c) {
                    roundWon = true;
                    winningLine = winCondition; // è®°å½•è·èƒœçš„çº¿
                    break; // æ‰¾åˆ°è·èƒœè€…ï¼Œé€€å‡ºå¾ªç¯
                }
            }

            // å¤„ç†è·èƒœæƒ…å†µ
            if (roundWon) {
                messageDisplay.innerHTML = `ç©å®¶ ${currentPlayer} è·èƒœ! ğŸ‰`;
                gameActive = false; // æ¸¸æˆç»“æŸ
                // æ’­æ”¾èƒœåˆ©éŸ³æ•ˆ
                winSynth.triggerAttackRelease(['C5', 'E5', 'G5'], '1s');

                // ä¸ºè·èƒœçš„å•å…ƒæ ¼æ·»åŠ åŠ¨ç”»ç±»
                winningLine.forEach(index => {
                    cells[index].classList.add('winning-cell');
                });
                return;
            }

            // æ£€æŸ¥æ˜¯å¦å¹³å±€ï¼ˆæ‰€æœ‰å•å…ƒæ ¼éƒ½å·²å¡«å……ï¼Œä½†æ²¡æœ‰äººè·èƒœï¼‰
            let roundDraw = !board.includes(''); // å¦‚æœæ£‹ç›˜ä¸­æ²¡æœ‰ç©ºå•å…ƒæ ¼ï¼Œåˆ™ä¸ºå¹³å±€
            if (roundDraw) {
                messageDisplay.innerHTML = `å¹³å±€! ğŸ¤`;
                gameActive = false; // æ¸¸æˆç»“æŸ
                // æ’­æ”¾å¹³å±€éŸ³æ•ˆ
                drawSynth.triggerAttackRelease(['C4', 'Fs4', 'B4'], '0.8s');
                return;
            }

            // å¦‚æœæ¸¸æˆä»åœ¨è¿›è¡Œï¼Œåˆ™åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªç©å®¶
            currentPlayer = currentPlayer === 'X' ? 'O' : 'X';
            messageDisplay.innerHTML = `ç©å®¶ ${currentPlayer} çš„å›åˆ`;
        }

        /**
         * é‡æ–°å¼€å§‹æ¸¸æˆ
         */
        function restartGame() {
            // æ’­æ”¾é‡æ–°å¼€å§‹éŸ³æ•ˆ
            restartSynth.triggerAttackRelease('E5', '0.1s', Tone.now());
            restartSynth.triggerAttackRelease('C5', '0.1s', Tone.now() + 0.1);

            // é‡ç½®æ¸¸æˆæ¿çŠ¶æ€
            board = ['', '', '', '', '', '', '', '', ''];
            // é‡ç½®å½“å‰ç©å®¶ä¸º 'X'
            currentPlayer = 'X';
            // é‡æ–°æ¿€æ´»æ¸¸æˆ
            gameActive = true;
            // æ›´æ–°æ¶ˆæ¯æ˜¾ç¤º
            messageDisplay.innerHTML = `ç©å®¶ X çš„å›åˆ`;
            // æ¸…ç©ºæ‰€æœ‰å•å…ƒæ ¼çš„å†…å®¹å’Œæ ·å¼ï¼Œå¹¶ç§»é™¤æ‰€æœ‰åŠ¨ç”»ç±»
            cells.forEach(cell => {
                cell.innerHTML = '';
                cell.classList.remove('x', 'o', 'pop', 'winning-cell'); // ç§»é™¤æ‰€æœ‰ç›¸å…³ç±»
            });
        }

        // ä¸ºæ¯ä¸ªå•å…ƒæ ¼æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
        cells.forEach(cell => cell.addEventListener('click', handleCellClick));
        // ä¸ºé‡æ–°å¼€å§‹æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
        restartButton.addEventListener('click', restartGame);
        // ä¸ºéŸ³ä¹å¼€å…³æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
        musicToggleButton.addEventListener('click', toggleMusic);

        // åˆå§‹æ¶ˆæ¯è®¾ç½®
        // ç¬¬ä¸€æ¬¡ç”¨æˆ·ç‚¹å‡»ï¼ˆä»»ä½•åœ°æ–¹ï¼‰ä¼šå°è¯•åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡
        document.body.addEventListener('click', initializeAudioContext, { once: true });
    </script>
</body>
</html>
